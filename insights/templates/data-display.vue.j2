{% extends 'base.html.j2' %}

{% block headscripts %}
{{ super() }}

<link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet' />
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}" />

{% endblock headscripts %}

{% block bodyscripts %}
{{ super() }}
<script>
    const MAPBOX_ACCESS_TOKEN = {{ config.MAPBOX_ACCESS_TOKEN|tojson }};
    const INSIGHTS_CONFIG = {{ config.INSIGHTS_CONFIG|tojson }};
    const TITLE = "{{ title }}";
    const SUBTITLE = "{{ subtitle }}";
  </script>
  <script type="module" src="{{ url_for('static', filename='js/data-display.js') }}"></script>
{% endblock bodyscripts %}

{% block content %}


{# We don't use a build system so we use the existing templating system to load Vue components #}
{% include 'components/loading.vue.j2' %}
{% include 'components/chart-card.vue.j2' %}
{% include 'components/filter-item.vue.j2' %}

<header class="layout__header wrapper" v-if="summary">
  {% include 'components/flash-messages.html.j2' %}
</header>

{% raw %}
<!-- insights VueJS application -->
<div id="data-display" v-cloak>
  <header class="layout__header wrapper" v-if="data">

    <div class="base-section">
      <div class="grid grid--single-column">
          <hgroup class="layout__header">
            <div class="hero-section">
              <div class="wrapper">
                <div class="hero hero--orange">
                  <!-- .hero--orange, .hero--yellow, .hero--red -->
                  <div class="hero__column hero__logo">
                    <a href="/"><img src="https://cdn.threesixtygiving.org/images/360-logos/insights/360insights-color.svg"
                        alt="360 "></a>
                  </div>
                  <div class="hero__column hero__lead" v-if="filtersApplied.length && !loading">
                    <h2 class="hero__title">{{ subtitle }}</h2>
                    <p class="hero__blurb">
                        <template v-if="funders && funders.length <= 5">
                          {{ funders.join(", ")}}
                        </template>
                        <template v-else>{{ title }}</template>

                        <template v-if="summary.minDate">
                          <template v-if="summary.minDate.slice(0,7) == summary.maxDate.slice(0,7)">
                            <small>in</small> {{ summary.minDate | formatDate('month') }}
                          </template>
                          <template v-else-if="summary.minDate.slice(0,4) == summary.maxDate.slice(0,4)">
                            <small>between</small> {{ summary.minDate | formatDate('month') }} <small>and</small> {{ summary.maxDate
                            | formatDate('month') }}
                          </template>
                          <template v-else>
                            <small>between</small> {{ summary.minDate | formatDate('year') }} <small>and</small> {{ summary.maxDate
                            | formatDate('year') }}
                          </template>
                        </template>
                    </p>
                  </div>
                  <div class="hero__column hero__lead" v-else>
                    <h2 class="hero__title">See your grantmaking in new ways</h2>
                    <p class="hero__blurb">Combine and visualise 360Giving, charity and other data to answer questions about your
                      grantmaking</p>
                  </div>
                </div>
              </div>
            </div>
          <div class="fix-spinner-position">
            <loading v-if="loading"></loading>
          </div>
          </hgroup>

        <p class="header-group__excerpt">
          <template v-if="grantnavUrl && dataset == 'main'">
            <a v-bind:href="grantnavUrl" class="button hide-print" style="float:right">See in GrantNav</a>
          </template>

          <a href="#" class="button hide-print" title="Print this page" style="margin-right: 5px; padding-bottom: 2px; float:right" onclick="window.print()"><i class="material-icons">print</i></a>

          <template v-if="sources.length == 1 && sources[0].distribution[0]"> | <a
              v-bind:href="sources[0].distribution[0].downloadURL">Download original file</a><br>
            <template v-if="sources[0].publisher">Published by <a v-bind:href="sources[0].publisher.website">{{
                sources[0].publisher.name }}</a> with a <a v-bind:href="sources[0].license">{{ sources[0].licenseName
                }}</a> licence.</template></template>
          <template v-else-if="sources.length == 1">Original filename: <code>{{ sources[0].title }}</code></template>
        </p>
        <template v-if="sources.length > 1">
          <details class="header-group__excerpt">
            <summary>Data sources</summary>
            <table class="table table--zebra">
              <thead>
                <tr>
                  <th>Publisher</th>
                  <th>Source file</th>
                  <th>Licence</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="source in sources" :key="source.id">
                  <td><a v-bind:href="source.publisher.website">{{ source.publisher.name }}</a></td>
                  <td>
                    <a v-bind:href="source.distribution[0].accessURL">{{ source.title }}</a><br>
                    [<a v-bind:href="source.distribution[0].downloadURL">Download original file</a>]
                  </td>
                  <td><a v-bind:href="source.license">{{ source.licenseName }}</a></td>
                </tr>
              </tbody>
            </table>
          </details>
        </template>
      </div>

      <div class="spacer-3"></div>

      <!-- totals summary boxes -->

      <div class="grid grid--five-columns" v-if="data.hits" style="align-items: center;">
        <div class="grid__1">
          <div class="base-card base-card--orange" >
            <div class="base-card__content" style="display: flex; flex-direction: column; justify-content: center; min-height: 173px" >
              <h2 class="base-card__title">{{ data.hits.total.value | formatNumberSuffix }}{{ data.hits.total.value |
                getAmountSuffix(true) }}</h2>
              <p class="base-card__text">Grants <br/></p>
            </div>
          </div>
        </div>

        <div class="grid__1">
          <div class="base-card base-card--teal" >
            <div class="base-card__content" style="display: flex; flex-direction: column; justify-content: center; min-height: 173px">
              <h2 class="base-card__title">{{ data.aggregations.recipient_orgs.value.toLocaleString() }}</h2>
              <p class="base-card__text">Recipient Organisations</p>
            </div>
          </div>
        </div>

        <div class="grid__1">
          <div class="base-card base-card--teal" >
            <div class="base-card__content" style="display: flex; flex-direction: column; justify-content: center; min-height: 173px">
              <h2 class="base-card__title">{{ data.aggregations.recipient_indi.value.toLocaleString() }}</h2>
              <p class="base-card__text">Recipient Individuals</p>
            </div>
          </div>
        </div>

        <template v-for="currency in summary.currencies" v-if="currency.currency == currencyUsed">
          <div class="grid__1">
            <div class="base-card base-card--yellow"  >
              <div class="base-card__content" style="display: flex; flex-direction: column; justify-content: center;  min-height: 173px">
                <h2 class="base-card__title">{{ data.aggregations.currency_stats.buckets[0].amount_stats.sum | formatCurrency("GBP") }}{{ data.aggregations.currency_stats.buckets[0].amount_stats.sum | getAmountSuffix(true) }}</h2>
                <p class="base-card__text">Total</p>
              </div>
            </div>
          </div>

          <div class="grid__1">
            <div class="base-card base-card--black" >
              <div class="base-card__content" style="display: flex; flex-direction: column; justify-content: center;  min-height: 173px">
                <h2 class="base-card__title">{{ data.aggregations.funding_orgs.value.toLocaleString() }}</h2>
                <p class="base-card__text">Funders</p>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div class="grid grid--two-columns" v-html="insights_config.dataexplainer"></div>

    <div v-if="data.aggregations && data.aggregations.currency_stats.buckets.length > 1">
      This data also contains
      <ul>
        <li v-for="currency in data.aggregations.currency_stats.buckets" v-if="currency.key != 'GBP'">
          {{currency.doc_count| formatNumberSuffix}} grants awarded in {{currency.key}} totalling {{ currency.amount_stats.sum |
          formatCurrency(currency.key) }}{{ currency.amount_stats.sum| getAmountSuffix(true) }}.
        </li>
      </ul>
    </div>

      <!-- / totals summary boxes -->
  </header>

  <main class="layout__content">
    <div class="layout__content-inner" style="padding-top: 10px">
      <div class="box box--orange" v-if="summary.grants === 0 && dataset !== 'main'">
          <h3>No Dataset selected</h3>
          <p>There are currently no 360Giving datasets selected. <a href="/">Select a dataset.</a></p>
          <p>Note: Datasets imported from <a href="https://grantnav.threesixtygiving.org">GrantNav</a> expire after {{datasetExpiryDays}} days.</p>
      </div>

      <template v-else>

      <div class="grid grid--two-columns">

        <chart-card color="teal" class="hide-print" v-if="filtersApplied.length">
          <chart-card-header title="Dataset filters">
            <a href="/" title="See all available datasets">(back to dataset selection)</a>
          </chart-card-header>
<!-- TODO filters titles for new / filters -->
          <a href="#" v-bind:title="'Remove dataset filter '+filtersToTitles[filter]" class="filter filter--data-wrangling" v-for="filter in filtersApplied" v-on:click.prevent="resetFilter(filter)">{{filtersToTitles[filter]}} &times;</a>
        </chart-card>

        <!-- Funders -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="fundingOrganization" v-if="data.aggregations" ></bar-chart-card>
        <!-- Funding organisation type -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="fundingOrganizationTSGType" v-if="data.aggregations" ></bar-chart-card>
        <!-- Amount awarded -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="amountAwardedFixed" v-if="data.aggregations" ></bar-chart-card>

        <!-- Award date -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="awardYear" v-if="data.aggregations" ></bar-chart-card>

        <!-- Grant Programmes -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="grantProgramme" v-if="data.aggregations" ></bar-chart-card>

        <div class="spacer-3"></div>
        <div class="grid__all">
          <h3 v-if="!loading">Grants locations</h3>
        </div>

        <!-- Countries -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="recipientRegionName-countries" v-if="data.aggregations" ></bar-chart-card>
        <!-- Regions -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="recipientRegionName-regions" v-if="data.aggregations" ></bar-chart-card>
        <!--  Local Authorities -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="recipientDistrictName-la" v-if="data.aggregations" ></bar-chart-card>
        <!-- Choropleth -->
        <!-- <choropleth class="base-card__content" v-if="data.aggregations" :data-all="data" data-id="recipientDistrictName-map" container="ch-1" height="680px" :zoom-control="true" ></choropleth> -->
        <!-- Source of location information -->
        <!-- TODO -->

        <div class="spacer-3"></div>
        <div class="grid__all">
          <h3 v-if="!loading">Grant recipients</h3>
        </div>

        <!--  Type of grant recipient -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="recipientTSGType" v-if="data.aggregations" ></bar-chart-card>
        <!-- Recipient org Type -->
        <!-- TODO -->
        <!-- Latest Income -->
        <!-- TODO -->
        <!--Age of recipient org -->
        <!-- TODO -->

        </div> <!-- / grid -->
        <div class="grid__all">
          <h3 v-if="!loading">Grant types</h3>
        </div>

        <!--Age of recipient org -->
        <bar-chart-card v-on:select="updateData($event)" :data-all="data" data-id="simple_grant_type" v-if="data.aggregations" ></bar-chart-card>

      </template>

    </div> <!-- / layout content inner -->
  </main>
</div> <!-- / vue app -->
{% endraw %}

{% endblock content %}
