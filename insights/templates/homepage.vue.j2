{% extends 'base.html.j2' %}

{% block bodyscripts %}
  {{ super() }}
  <script>
    const UPLOAD_URL = {{ url_for('upload')|tojson }};
    const DATASET_SELECT = {{ dataset_select|tojson }};
    const DATASET_SELECT_SECTIONS = {
      funders: "Funders",
      funder_types: "Funding organisation type",
      // publishers: "Publishers",
      countries: "Countries",
      regions: "Regions",
      local_authorities: "Local authorities",
    };
  </script>
  <script type="module" src="{{ url_for('static', filename='js/homepage.js') }}"></script>
{% endblock %}

{% block content %}
  <header class="layout__header">
    {% include 'components/flash-messages.html.j2' %}
    <div class="hero-section">
      <div class="wrapper">
        <div class="hero hero--orange">
          <!-- .hero--orange, .hero--yellow, .hero--red -->
          <div class="hero__column hero__logo">
            <a href="/"><img src="https://cdn.threesixtygiving.org/images/360-logos/insights/360insights-color.svg"
                alt="360 "></a>
          </div>
          <div class="hero__column hero__lead">
            <h2 class="hero__title">See your grantmaking in new ways</h2>
            <p class="hero__blurb">Combine and visualise 360Giving, charity and other data to answer questions about your
              grantmaking</p>
          </div>
        </div>
      </div>
    </div>
  </header>

{# Start of homepage.js VueJS application #}
{% raw %}
  <main class="layout__content" id="app" v-cloak>
    <div class="layout__content-inner">
      <div class="accordian" v-bind:class="{ datasetModal: 'accordian--expanded' }">
    <div class="intro-section">
      <h2>Select a 360Giving dataset <br>or <a href="#upload-data">upload a file</a> that meets the 360Giving Standard.</h2>
      <div class="spacer-3"></div>
    </div>


 <template v-if="phase == 'one'" >
        <div class="grid grid--two-columns">

          <chart-card color="teal" v-bind:loading="false">
            <chart-card-header title="Funders">
              (number of grants)
            </chart-card-header>
            <template v-if="phase == 'one'">
            <ul class="bar-chart" style="overflow-y: auto; height:300px" >
              <li class="bar-chart__item"
                  v-bind:class="[ (filters.funders.indexOf(funder) > -1) || filters.funders.length == 0 ? '' : 'bar-unselected']"
                  v-for="funder in funderListInit"
                  v-bind:style="{ '--value': funder.grant_count, '--width': `${(funder.grant_count / datasetSelect.dataset_stats.grants_total) * 100}%`  }"
              >
                <label class="bar-chart__label" >
                  <a href="#" v-on:click.prevent="toggleInArray(filters.funders, funder); ">{{funder.name}}</a>
                </label>
                <div class="bar-chart__bar" v-on:click.prevent="toggleInArray(filters.funders, funder); " ><span></span></div>
              </li>
            </ul>
            <input type="text" placeholder="Find a funder" v-model="find.funder" class="search-field" />
            <div class="spacer-2"></div>
            <a href="#" v-on:click.prevent="toggleInArray(filters.funders, funder)" v-for="funder in filters.funders" class="filter filter--data-wrangling" style="margin: 5px;" v-bind:title="`Remove ${funder.name}`">{{funder.name}} &times;</a>

            <button class="button button--teal" style="margin-left: auto; display:block;" v-on:click.prevent="phase='two'">Done</button>
            </template>

            <loading v-show="loading"></loading>

            <ul class="bar-chart" v-if="filters.funders.length > 0 && phase == 'two' && !loading">
              <li class="bar-chart__item" v-for="funder in filters.funders" v-bind:style="{ '--value': funder.grant_count, '--width': `${(funder.grant_count / summary.grants) * 100}%`  }">
                <label class="bar-chart__label">
                  {{funder.name}}
                </label>
                <div class="bar-chart__bar"><span></span></div>
              </li>
            </ul>

            <button v-if="phase == 'two' && !loading" class="button button--teal" style="margin-left: auto; display:block;" v-on:click.prevent="phase='one'">Edit selection</button>
          </chart-card>


          <chart-card color="teal" v-bind:loading="false">
            <chart-card-header title="Funder types">
              (number of grants)
            </chart-card-header>
            <template v-if="phase == 'one'">
            <ul class="bar-chart" style="overflow-y: auto; height:300px" >
              <li class="bar-chart__item"
                  v-bind:class="[ (filters.funderTypes.indexOf(funderType) > -1) || filters.funderTypes.length == 0 ? '' : 'bar-unselected']"
                  v-for="funderType in funderTypeListInit"
                  v-bind:style="{ '--value': funderType.grant_count, '--width': `${(funderType.grant_count / datasetSelect.dataset_stats.grants_total) * 100}%`  }"
              >
                <label class="bar-chart__label" >
                  <a href="#" v-on:click.prevent="toggleInArray(filters.funderTypeTypes, funderType); ">{{funderType.name}}</a>
                </label>
                <div class="bar-chart__bar" v-on:click.prevent="toggleInArray(filters.funderTypes, funderType); " ><span></span></div>
              </li>
            </ul>
            <input type="text" placeholder="Find funderType" v-model="find.funderTypes" class="search-field" />
            <div class="spacer-2"></div>
            <a href="#" v-on:click.prevent="toggleInArray(filters.funderTypes, funderType)" v-for="funderType in filters.funderTypes" class="filter filter--data-wrangling" style="margin: 5px;" v-bind:title="`Remove ${funderType.name}`">{{funderType.name}} &times;</a>

            <button class="button button--teal" style="margin-left: auto; display:block;" v-on:click.prevent="phase='two'">Done</button>
            </template>

            <loading v-show="loading"></loading>

            <ul class="bar-chart" v-if="filters.funderTypes.length > 0 && phase == 'two' && !loading">
              <pre>disabled</pre>
              <li class="bar-chart__item" v-for="funderType in filters.funderTypes" v-bind:style="{ '--value': funderType.grant_count, '--width': `${(funderType.grant_count / summary.grants) * 100}%`  }">
                <label class="bar-chart__label">
                  {{funderType.name}}
                </label>
                <div class="bar-chart__bar"><span></span></div>
              </li>
            </ul>

            <button v-if="phase == 'two' && !loading" class="button button--teal" style="margin-left: auto; display:block;" v-on:click.prevent="phase='one'">Edit selection</button>
          </chart-card>


        </div>
      </template>


    <ul class="card-list">
      <li class="card-list__item" v-for="(title, index) in datasetSelectSections" v-if="getDatasetOptions(index).length > 0">
        <article class="media-card media-card--teal">
          <div class="media-card__content">
            <header class="media-card__header">
              <h3 class="media-card__heading">{{ title }}</h3>
            </header>
            <template v-if="getDatasetOptions(index).length > 0" >

              <multi-select v-model="multiSelect[index]" :option-height="100" :searchable="true" :close-on-select="false" :multiple="true" :taggable="true" :options="datasetSelect[index]" label="name" track-by="id" :placeholder="'Select '+title.toLowerCase()" v-on:select="multiSelectSelected(index, $event)">
                <template slot="option" slot-scope="props">
                  {{props.option.name}} ({{props.option.grant_count|formatNumber}})
                </template>
             </multi-select>


            <p v-if="multiSelectGrantTotals[index].totalGrants > 0">
             Total grants: {{multiSelectGrantTotals[index].totalGrants|formatNumber}}
            </p>

              <div class="spacer-3"></div>
              <button class="button button--teal" v-on:click="viewInsights(index, $event)">View Insights</button>
            </template>
            <ul v-else class="dataset-select">
              <li v-for="item in getDatasetOptions(index)">
                <a v-bind:href="item.url" class="filter filter--data-wrangling"><span class="">{{ item.name }}</span> ({{ item.grant_count|formatNumber }})</a>
              </li>
            </ul>
          </div>
        </article>
      </li>
      <li class="card-list__item">
  <article class="media-card media-card--red media-card--self-contained" id="upload-data">
    <div class="media-card__content">
      <header class="media-card__header">
        <h3 class="media-card__heading">Upload your own file</h3>
      </header>
      <p>Upload a file that meets the <a href="https://standard.threesixtygiving.org/" >360Giving Data Standard</a>.</p>
      <button class="button button--red modal__trigger" v-on:click.stop="uploadModal = !uploadModal" data-id="modal-01">Upload Dataset</button>
    </div>
  </article>
      </li>
      <li class="card-list__item">
  <article class="media-card media-card--orange media-card--self-contained">
    <div class="media-card__content">
      <header class="media-card__header">
        <h3 class="media-card__heading">Data Sources</h3>
      </header>
      <p>Charity data is sourced from <a href="https://findthatcharity.uk/" target="_blank" rel="noreferrer">findthatcharity.uk</a> and postcode data from <a href="https://findthatpostcode.uk/" target="_blank" rel="noreferrer">postcodes.findthatcharity.uk</a>. Company data is fetched using Companies House URIs. All external data is used under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noreferrer">Open Government Licence</a>.</p>
      <p><a href="https://insights.threesixtygiving.org/about#data-sources">More about data sources</a></p>
    </div>
  </article>
      </li>
    </ul>
  </div>

  <!-- upload file modal -->
  <div id="modal-01" class="modal" v-bind:class="{ 'modal--shown': uploadModal }" v-if="uploadModal">
    <div class="modal__overlay modal__trigger" data-id="modal-01"></div>
    <div class="modal__window">
      <button class="modal__close modal__trigger" data-id="modal-01" v-on:click.stop="uploadModal = !uploadModal"></button>
      <div class="modal__content">
        <template v-if="uploadStatus=='uploading'">
          <h4>Uploading {{ uploadFile.name }}</h4>
          <loading v-if="loading"></loading>
        </template>
        <template v-else>
          <input type="file" v-on:change.prevent="addFile" ref="uploadFileInput" style="display: none" />
          <div class="upload-file drag-drop" v-if="!uploadFile" v-on:click.prevent="openFileDialog" v-on:drop.prevent="addFile" v-on:dragover.prevent="">
            <h3 class="margin-bottom:05 margin-top:05">Drop your file here</h3>
          </div>
          <div class="upload-file drag-drop padding-left:1 padding-right:1 padding-top:1 padding-bottom:1" v-on:click.prevent="openFileDialog" v-on:drop.prevent="addFile" v-on:dragover.prevent="" v-else>
            <code>{{ uploadFile.name }}</code>
          </div>
          <div v-if="uploadFile" class="grid grid--four-columns margin-top:3">
            <div class="grid__1">
              <label for="source-title">File title</label>
            </div>
            <div class="grid__3">
              <input class="filter-input search-field" id="source-title"  v-model="uploadSourceTitle" />
            </div>
            <div class="grid__all">
              <button v-on:click.prevent="startUpload" class="button button--orange">Upload file</button>
              <button v-on:click.prevent="uploadFile = null; uploadSourceTitle = null;" class="button button--small margin-left:2">Choose a different file</button>
            </div>
          </div>
        </template>

        <div class="box box--red margin-top:2 padding-left:1 padding-right:1 padding-top:1 padding-bottom:1" v-if="uploadError">
          <h3 class="box__heading">Error</h3>
          <p>{{ uploadError }}</p>
        </div>

        <h4>Data Privacy Information</h4>
        <p>Please ensure that you have the appropriate permissions to upload data into 360Insights.</p>
        <p>Do not submit confidential or non-public personal data to this tool.</p>
        <p>Read our <a href="/about#data-upload" target="_blank">privacy notice<span class="screen-reader-only">(opens in a new tab)</span></a> for further information.</p>
        <p><strong>File size</strong>: Large files (above 10Mb) may not work properly.</p>
      </div>
    </div>
  </div>
  <!-- / upload modal -->

  </main>
{% endraw %}
{# End of homepage.js VueJS application #}
{% endblock content %}